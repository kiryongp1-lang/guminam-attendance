<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>êµ¬ë¯¸ë‚¨ ì´ˆ2 ì¶œì„ë¶€</title>

<!-- ëª¨ë°”ì¼ ìµœì í™” -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SheetJS (ì—‘ì…€ ì €ì¥) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 15px;
    max-width: 900px;
    margin: auto;
  }
  h1 { font-size: 22px; text-align:center; }

  .box {
    border:1px solid #ccc;
    padding:15px;
    margin-bottom:20px;
    border-radius:10px;
    background:white;
  }

  button {
    padding:10px 14px;
    border:none;
    background:#007bff;
    color:white;
    border-radius:6px;
    margin-top:8px;
    cursor:pointer;
  }
  button:active { opacity:0.8; }

  input, select {
    padding:8px;
    margin:5px 0;
    width:100%;
    box-sizing:border-box;
  }

  .student-row {
    display:flex;
    justify-content:space-between;
    padding:6px 0;
    border-bottom:1px solid #eee;
    font-size:15px;
  }

  .status-radio input {
    transform:scale(1.2);
    margin-right:5px;
  }

  .missingBox {
    background:#ffeaea;
    padding:10px;
    border:1px solid red;
    border-radius:6px;
    margin-top:10px;
  }
  .clickable { color:red; cursor:pointer; font-weight:bold; }

  table {
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
    font-size:14px;
  }
  th, td {
    border:1px solid #aaa;
    padding:6px;
    text-align:center;
  }
  th { background:#f2f2f2; }
  .red { color:red; font-weight:bold; }

  .hidden { display:none; }
</style>
</head>

<body>

<h1>êµ¬ë¯¸ë‚¨ ì´ˆ2 ì¶œì„ë¶€(1ë¶€ë“±ë¡)</h1>

<!-- í•™ìƒ ë“±ë¡ -->
<button onclick="toggleRegisterUI()">í•™ìƒ ë“±ë¡</button>
<div id="registerUI" class="hidden box">
  <h2>í•™ë…„ / ë°˜ / í•™ìƒ ë“±ë¡</h2>
  <label>í•™ë…„</label>
  <input type="text" id="regGrade">

  <label>ë°˜</label>
  <input type="text" id="regClass">

  <label>í•™ìƒ ì´ë¦„</label>
  <input type="text" id="regStudent">

  <button onclick="registerStudent()">ë“±ë¡</button>
</div>

<!-- ì¶œì„ ì²´í¬ -->
<div class="box">
  <h2>ì¶œì„ ì²´í¬</h2>

  <label>ë‚ ì§œ ì„ íƒ (ì¼ìš”ì¼ë§Œ)</label>
  <input type="date" id="attDate" onchange="onSelectDate()">

  <div id="missingClassBox"></div>

  <label>í•™ë…„ ì„ íƒ</label>
  <select id="attGrade" onchange="loadClasses()"></select>

  <label>ë°˜ ì„ íƒ</label>
  <select id="attClass" onchange="loadStudents()"></select>

  <div id="studentList"></div>

  <button onclick="saveAttendance()">ì¶œì„ ì €ì¥</button>
</div>

<!-- ì¼ë³„ ì¡°íšŒ -->
<div class="box">
  <h2>ì¼ë³„ ì¡°íšŒ</h2>
  <input type="date" id="dailyQuery" onchange="queryDaily()">

  <button onclick="downloadDailyExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>

  <div id="dailyResult"></div>
</div>

<!-- ì›”ë³„ ì¡°íšŒ -->
<div class="box">
  <h2>ì›”ë³„ ì¡°íšŒ</h2>
  <input type="month" id="monthlyQuery" onchange="queryMonthly()">

  <button onclick="downloadMonthlyExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>

  <div id="monthlyResult"></div>
</div>

<script type="module">

/* ---------------------------------------
    Firebase Firestore ì„¤ì •
--------------------------------------- */
import { initializeApp } 
  from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";

import {
  getFirestore, doc, setDoc,
  collection, getDocs,
  query, where,
  writeBatch
} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";


const firebaseConfig = {
  apiKey: "AIzaSyAqOhG9cyAdrEPR_d2xRwJKDreud4mBIpk",
  authDomain: "guminam-70f61.firebaseapp.com",
  projectId: "guminam-70f61",
  storageBucket: "guminam-70f61.firebasestorage.app",
  messagingSenderId: "657304988654",
  appId: "1:657304988654:web:29f66969eb844711723cff",
  measurementId: "G-7N0PHE3P8Z"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------------------------------------
    ì „ì—­ ë°ì´í„°
--------------------------------------- */
let classes = {};
let attendance = {};

async function loadAllData() {
  classes = {};
  attendance = {};

  const cls = await getDocs(collection(db, "classes"));
  cls.forEach(d => classes[d.id] = d.data().students);

  const att = await getDocs(collection(db, "attendance"));
  att.forEach(d => attendance[d.id] = d.data());

  loadGradeDropdown();
}
await loadAllData();

/* ---------------------------------------
    UI ë„êµ¬
--------------------------------------- */
function $(id){ return document.getElementById(id); }

/* ---------------------------------------
    í•™ìƒ ë“±ë¡
--------------------------------------- */
window.toggleRegisterUI = function(){
  $("registerUI").classList.toggle("hidden");
}

window.registerStudent = async function(){
  const g = $("regGrade").value.trim();
  const c = $("regClass").value.trim();
  const s = $("regStudent").value.trim();

  if(!g || !c || !s) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");

  const key = `${g}-${c}`;

  if(!classes[key]) classes[key] = [];
  if(!classes[key].includes(s)) classes[key].push(s);

  await setDoc(doc(db, "classes", key), { students: classes[key] });

  alert("ë“±ë¡ ì™„ë£Œ!");
  loadGradeDropdown();
};

/* ---------------------------------------
    í•™ë…„ dropbox ì±„ìš°ê¸° (í•™ìƒ ìˆëŠ” ë°˜ë§Œ ëŒ€ìƒ)
--------------------------------------- */
function loadGradeDropdown(){
  const sel = $("attGrade");
  sel.innerHTML = `<option value=''>ì„ íƒ</option>`;

  // í•™ìƒì´ 1ëª… ì´ìƒ ìˆëŠ” ë°˜ë§Œ í•™ë…„ ëª©ë¡ì— ë°˜ì˜
  const grades = [...new Set(
    Object.keys(classes)
      .filter(k => Array.isArray(classes[k]) && classes[k].length > 0)
      .map(k => k.split("-")[0])
  )];

  grades.forEach(g => sel.innerHTML += `<option value="${g}">${g}</option>`);
}

/* ---------------------------------------
    í•™ë…„ ì„ íƒ â†’ ë°˜ ëª©ë¡ ë¡œë“œ (í•™ìƒ ìˆëŠ” ë°˜ë§Œ)
--------------------------------------- */
window.loadClasses = function(){
  const g = $("attGrade").value;
  const sel = $("attClass");

  sel.innerHTML = `<option value="">ì„ íƒ</option>`;

  // í•´ë‹¹ í•™ë…„ì´ë©´ì„œ, ì‹¤ì œ í•™ìƒì´ 1ëª… ì´ìƒ ìˆëŠ” ë°˜ë§Œ í‘œì‹œ
  Object.keys(classes)
    .filter(k => 
      k.split("-")[0] === g &&
      Array.isArray(classes[k]) && classes[k].length > 0
    )
    .forEach(k => {
      const c = k.split("-")[1];
      sel.innerHTML += `<option value="${c}">${c}</option>`;
    });

  loadStudents();
};

/* ---------------------------------------
    ë°˜ ì„ íƒ â†’ í•™ìƒ ëª©ë¡ í‘œì‹œ + ê¸°ì¡´ ì¶œì„ ë°˜ì˜
--------------------------------------- */
window.loadStudents = function(){
  const g = $("attGrade").value;
  const c = $("attClass").value;
  const key = `${g}-${c}`;
  const date = $("attDate").value;

  const box = $("studentList");
  if(!classes[key]){ box.innerHTML = ""; return; }

  const dayData = attendance[date]?.[key] || {};

  box.innerHTML = classes[key].map(st => {
    const prev = dayData[st] || "ë¯¸ì²´í¬";
    return `
      <div class="student-row">
        <b>${st}</b>
        <label><input type="radio" name="st_${st}" value="present"
          ${prev === "present" ? "checked" : ""}> ì¶œì„</label>

        <label><input type="radio" name="st_${st}" value="absent"
          ${prev === "absent" ? "checked" : ""}> ê²°ì„</label>

        <label><input type="radio" name="st_${st}" value="delete"> 
          âŒ ì‚­ì œ(ëª…ë‹¨)
        </label>
      </div>
    `;
  }).join('');
};


/* ---------------------------------------
    ë‚ ì§œ ì„ íƒ (ì¼ìš”ì¼ë§Œ)
--------------------------------------- */
window.onSelectDate = function(){
  const d = new Date($("attDate").value);
  if(d.getDay() !== 0){
    alert("ì¼ìš”ì¼ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    $("attDate").value = "";
    return;
  }
  showMissingClasses();
};

/* ---------------------------------------
    ë¯¸ì²´í¬ ë°˜ í‘œì‹œ (í•™ìƒ ì—†ëŠ” ë°˜ ì œì™¸)
--------------------------------------- */
function showMissingClasses(){
  const date = $("attDate").value;
  const box = $("missingClassBox");

  const data = attendance[date] || {};

  // ì‹¤ì œ í•™ìƒì´ 1ëª… ì´ìƒ ìˆëŠ” ë°˜ë§Œ ëŒ€ìƒìœ¼ë¡œ
  const activeClasses = Object.keys(classes)
    .filter(k => Array.isArray(classes[k]) && classes[k].length > 0);

  // ğŸ”¥ 'ë¯¸ì²´í¬ ë°˜' íŒë‹¨ ë¡œì§
  const missing = activeClasses.filter(key => {
    const students = classes[key];
    const dayData = data[key] || {};

    // í•™ìƒ ì¤‘ í•˜ë‚˜ë¼ë„ ì¶œì„/ê²°ì„ ì²´í¬ê°€ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ë¯¸ì²´í¬ ì²˜ë¦¬
    return students.some(st => {
      const v = dayData[st];
      return !(v === "present" || v === "absent" || v === "delete");
    });
  });

  if(missing.length === 0){
    box.innerHTML = "<b>ëª¨ë“  ë°˜ì´ ì²´í¬ë˜ì—ˆìŠµë‹ˆë‹¤.</b>";
    return;
  }

  box.innerHTML = `
    <div class='missingBox'>
      <b>ì¶œì„ ë¯¸ì²´í¬ ë°˜:</b><br>
      ${missing.map(k => 
        `<div class="clickable" onclick="selectClass('${k}')">${k}</div>`
      ).join("")}
    </div>
  `;
}

window.selectClass = function(key){
  const [g,c] = key.split("-");
  $("attGrade").value = g;
  loadClasses();
  $("attClass").value = c;
  loadStudents();
};

/* ---------------------------------------
    ì¶œì„ ì €ì¥
--------------------------------------- */
window.saveAttendance = async function(){
  const date = $("attDate").value;
  const g = $("attGrade").value;
  const c = $("attClass").value;

  if(!date || !g || !c) return alert("ë‚ ì§œ/í•™ë…„/ë°˜ì„ ì…ë ¥í•˜ì„¸ìš”.");

  const key = `${g}-${c}`;

  if(!classes[key]) return;

  if(!attendance[date]) attendance[date] = {};
  if(!attendance[date][key]) attendance[date][key] = {};

  const newStudentList = [];

  for(const st of classes[key]){

    const sel = document.querySelector(`input[name="st_${st}"]:checked`);
    const state = sel ? sel.value : "ë¯¸ì²´í¬";

    // ì‚­ì œì¸ ê²½ìš° â†’ ëª…ë‹¨ì—ì„œ ì œê±°
    if(state === "delete"){
      const ok = confirm(`${st} í•™ìƒì„ ëª…ë‹¨ì—ì„œ ì‚­ì œí• ê¹Œìš”?`);
      if(ok){
        // ì¶œì„ê¸°ë¡ì—ì„œë„ ì‚­ì œ
        delete attendance[date][key][st];
        continue; // ëª…ë‹¨ì—ë„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
      }
    }

    // ì¶œê²° ìƒíƒœ ì €ì¥
    attendance[date][key][st] = state;
    newStudentList.push(st);
  }

  // Firestore ëª…ë‹¨ ì—…ë°ì´íŠ¸
  classes[key] = newStudentList;
  await setDoc(doc(db, "classes", key), { students: newStudentList });

  // ì¶œì„ ì €ì¥
  await setDoc(doc(db, "attendance", date), attendance[date]);

  alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");

  loadStudents();        // ëª…ë‹¨ ìƒˆë¡œê³ ì¹¨
  showMissingClasses();  // ë¯¸ì²´í¬ ë°˜ ê°±ì‹ 
};

// âœ… batch 500 ì œí•œ íšŒí”¼(ì—¬ìœ  ìˆê²Œ 450ê°œì”©)
async function commitInChunks(db, ops, chunkSize = 450) {
  for (let i = 0; i < ops.length; i += chunkSize) {
    const batch = writeBatch(db);
    ops.slice(i, i + chunkSize).forEach(fn => fn(batch));
    await batch.commit();
  }
}

// âœ… "íŠ¹ì • ë°˜í‚¤(classKey)"ê°€ í¬í•¨ëœ attendance ë¬¸ì„œë§Œ ì¡°íšŒ (ê°€ëŠ¥í•˜ë©´ where, ì‹¤íŒ¨ ì‹œ ì „ì²´ ìŠ¤ìº”)
async function getAttendanceDocsHavingClassKey(classKey){
  let docs = [];
  try{
    const q = query(collection(db, "attendance"), where(classKey, "!=", null));
    const snap = await getDocs(q);
    snap.forEach(d => docs.push({ id: d.id, data: d.data() }));
    return docs;
  }catch(e){
    console.warn("where ì¡°íšŒ ì‹¤íŒ¨ â†’ ì „ì²´ ìŠ¤ìº” fallback", e);
    const snapAll = await getDocs(collection(db, "attendance"));
    snapAll.forEach(d => {
      const data = d.data();
      if(data && data[classKey] != null) docs.push({ id: d.id, data });
    });
    return docs;
  }
}

// âœ… ì´ë¦„(í•™ìƒ) ê¸°ì¤€ìœ¼ë¡œ ë°˜ ì´ë™(í•™ë…„/ë°˜ ìˆ˜ì •)
// - classes: oldKeyì—ì„œ í•™ìƒ ì œê±°, newKeyì— í•™ìƒ ì¶”ê°€
// - attendance: oldKeyê°€ ìˆëŠ” ë¬¸ì„œë§Œ ì°¾ì•„ì„œ ê·¸ ë¬¸ì„œ ì•ˆì—ì„œ í•™ìƒ ì¶œì„ ë°ì´í„°ë¥¼ oldKey â†’ newKeyë¡œ ì´ë™
window.moveStudentClass = async function(oldKey, studentName){
  const safeKey = encodeURIComponent(oldKey);
  const safeName = encodeURIComponent(studentName);

  // âœ… queryDailyì—ì„œ ë§Œë“  input id ê·œì¹™ì— ë§ì¶¤
  const gEl = document.getElementById(`mvGrade_${safeKey}_${safeName}`);
  const cEl = document.getElementById(`mvClass_${safeKey}_${safeName}`);
  if(!gEl || !cEl) return;

  const newGrade = (gEl.value || "").trim();
  const newClass = (cEl.value || "").trim();
  if(!newGrade || !newClass) return alert("í•™ë…„/ë°˜ì„ ì…ë ¥í•˜ì„¸ìš”.");

  const newKey = `${newGrade}-${newClass}`;
  if(newKey === oldKey){
    alert("ë³€ê²½ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  if(!Array.isArray(classes[newKey])) classes[newKey] = [];

  if(classes[newKey].includes(studentName)){
    return alert(`ì´ë™ ë¶ˆê°€: ${newKey} ë°˜ì— ì´ë¯¸ '${studentName}'ì´(ê°€) ìˆìŠµë‹ˆë‹¤.`);
  }

  const ok = confirm(`í•™ìƒ ë°˜ ì´ë™ì„ ì €ì¥í• ê¹Œìš”?\n${studentName}\n${oldKey} â†’ ${newKey}\n(ì¶œì„ ë°ì´í„°ë„ í•¨ê»˜ ì´ë™í•©ë‹ˆë‹¤)`);
  if(!ok) return;

  try{
    // oldKeyê°€ í¬í•¨ëœ attendance ë¬¸ì„œë§Œ ì¡°íšŒ
    const attDocs = await getAttendanceDocsHavingClassKey(oldKey);

    // classes ë©”ëª¨ë¦¬ ì´ë™
    classes[oldKey] = (classes[oldKey] || []).filter(n => n !== studentName);
    classes[newKey].push(studentName);

    // attendance ë©”ëª¨ë¦¬ ì´ë™ (oldKeyê°€ ìˆëŠ” ë¬¸ì„œë§Œ)
    attDocs.forEach(({ id, data }) => {
      if(!attendance[id]) attendance[id] = data;

      const docData = attendance[id];
      const oldClassData = docData?.[oldKey];
      if(!oldClassData) return;

      const v = oldClassData[studentName];
      if(v == null) return;

      if(!docData[newKey]) docData[newKey] = {};
      if(docData[newKey][studentName] != null){
        throw new Error(`ì¶œì„ ë°ì´í„° ì¶©ëŒ: ${id} ë¬¸ì„œì˜ ${newKey}ì— ì´ë¯¸ ${studentName} ê¸°ë¡ì´ ì¡´ì¬í•©ë‹ˆë‹¤.`);
      }

      docData[newKey][studentName] = v;
      delete oldClassData[studentName];
    });

    // Firestore ì—…ë°ì´íŠ¸ ops êµ¬ì„±
    const ops = [];
    ops.push(b => b.set(doc(db, "classes", oldKey), { students: classes[oldKey] || [] }));
    ops.push(b => b.set(doc(db, "classes", newKey), { students: classes[newKey] || [] }));
    attDocs.forEach(({ id }) => {
      ops.push(b => b.set(doc(db, "attendance", id), attendance[id]));
    });

    await commitInChunks(db, ops, 450);

    alert(`ì €ì¥ ì™„ë£Œ!\n${studentName}\n${oldKey} â†’ ${newKey}\n(ì—…ë°ì´íŠ¸ ë¬¸ì„œ ìˆ˜: ${attDocs.length})`);

    loadGradeDropdown();
    if(document.getElementById("dailyQuery")?.value) queryDaily();
    showMissingClasses();
    loadStudents();

  }catch(ex){
    console.error(ex);
    alert("ë°˜ ì´ë™ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n(ì½˜ì†” ë¡œê·¸ í™•ì¸)");
  }
};



/* ---------------------------------------
    ì¼ë³„ ì¡°íšŒ
--------------------------------------- */
/* ---------------------------------------
    ì¼ë³„ ì¡°íšŒ (í•™ë…„-ë°˜ ìˆœì„œ + ì´ë¦„ ì˜¤ë¥¸ìª½)
--------------------------------------- */
window.queryDaily = function(){
  const date = $("dailyQuery").value;
  const box = $("dailyResult");
  const data = attendance[date] || {};

  if(!date){
    box.innerHTML = "";
    return;
  }

  // (ë°˜í‚¤, í•™ìƒì´ë¦„) í˜•íƒœë¡œ í¼ì¹˜ê¸°
  const rows = [];
  Object.keys(classes).forEach(classKey => {
    const list = classes[classKey] || [];
    list.forEach(name => rows.push({ name, classKey }));
  });

  // âœ… í•™ë…„â†’ë°˜â†’ì´ë¦„ ìˆœì„œ ì •ë ¬
  rows.sort((a, b) => {
    const [ag, ac] = String(a.classKey).split("-");
    const [bg, bc] = String(b.classKey).split("-");

    // ìˆ«ì ê°€ëŠ¥í•˜ë©´ ìˆ«ì ì •ë ¬, ì•„ë‹ˆë©´ ë¬¸ìì—´ ì •ë ¬
    const agn = Number(ag), acn = Number(ac);
    const bgn = Number(bg), bcn = Number(bc);

    const agIsNum = !Number.isNaN(agn) && ag !== "";
    const bgIsNum = !Number.isNaN(bgn) && bg !== "";
    if(agIsNum && bgIsNum && agn !== bgn) return agn - bgn;
    if(!(agIsNum && bgIsNum)){
      const r = String(ag).localeCompare(String(bg), "ko");
      if(r !== 0) return r;
    }

    const acIsNum = !Number.isNaN(acn) && ac !== "";
    const bcIsNum = !Number.isNaN(bcn) && bc !== "";
    if(acIsNum && bcIsNum && acn !== bcn) return acn - bcn;
    if(!(acIsNum && bcIsNum)){
      const r = String(ac).localeCompare(String(bc), "ko");
      if(r !== 0) return r;
    }

    return String(a.name).localeCompare(String(b.name), "ko");
  });

  // âœ… html ì‹œì‘
  let html = `
    <table>
      <tr>
        <th style="width:18%;">í˜„ì¬ í•™ë…„-ë°˜</th>
        <th style="width:20%;">ë³€ê²½ í•™ë…„</th>
        <th style="width:20%;">ë³€ê²½ ë°˜</th>
        <th style="width:10%;">ìƒíƒœ</th>
        <th style="width:10%;">ì €ì¥</th>
        <th style="width:22%;">ì´ë¦„</th>
      </tr>
  `;

  rows.forEach(r => {
    const name = r.name;
    const oldKey = r.classKey;

    const [g0, c0] = String(oldKey).split("-");
    const safeKey = encodeURIComponent(oldKey);
    const safeName = encodeURIComponent(name);

    // ìƒíƒœ í‘œì‹œ
    let v = data[oldKey]?.[name] || "ë¯¸ì²´í¬";
    if(v === "present") v = "ì¶œì„";
    else if(v === "absent") v = "<span class='red'>ê²°ì„</span>";
    else if(v === "delete") v = "<span class='red'>ì‚­ì œ</span>";
    else v = "<span class='red'>ë¯¸ì²´í¬</span>";

    html += `
      <tr>
        <td>${oldKey}</td>

        <td>
          <input id="mvGrade_${safeKey}_${safeName}" value="${g0 || ""}" style="width:100%;">
        </td>

        <td>
          <input id="mvClass_${safeKey}_${safeName}" value="${c0 || ""}" style="width:100%;">
        </td>

        <td>${v}</td>

        <td>
          <button onclick="moveStudentClass('${oldKey}', '${name}')">ì €ì¥</button>
        </td>

        <td><b>${name}</b></td>
      </tr>
    `;
  });

  html += `</table>`;
  box.innerHTML = html;
};



/* ---------------------------------------
    ì›”ë³„ ì¡°íšŒ
--------------------------------------- */
window.queryMonthly = function(){
  const m = $("monthlyQuery").value;
  const year = m.split("-")[0];
  const month = Number(m.split("-")[1]);

  const days = [];

  for(let i=1;i<=31;i++){
    const d = new Date(`${m}-${String(i).padStart(2,'0')}`);
    if(d.getMonth()+1 !== month) continue;
    if(d.getDay() === 0)
      days.push(`${m}-${String(i).padStart(2,'0')}`);
  }

  let html = `<table><tr><th>í•™ë…„-ë°˜/í•™ìƒ</th>`;
  days.forEach(d => html += `<th>${d}</th>`);
  html += "</tr>";

  Object.keys(classes).forEach(key=>{
    classes[key].forEach(st=>{
      html += `<tr><td>${key}/${st}</td>`;
      days.forEach(day=>{
        let v = attendance[day]?.[key]?.[st] || "ë¯¸ì²´í¬";

        if(v==="present") v="ì¶œì„";
        else if(v==="absent") v="<span class='red'>ê²°ì„</span>";
        else if(v==="delete") v="<span class='red'>ì‚­ì œ</span>";
        else v="<span class='red'>ë¯¸ì²´í¬</span>";

        html += `<td>${v}</td>`;
      });
      html += "</tr>";
    });
  });

  $("monthlyResult").innerHTML = html + "</table>";
};

/* ---------------------------------------
    ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
--------------------------------------- */
window.downloadDailyExcel = function(){
  const table = document.querySelector("#dailyResult table");
  if(!table) return alert("ì¡°íšŒ í›„ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

  const wb = XLSX.utils.table_to_book(table, {sheet:"ì¼ë³„ ì¡°íšŒ"});
  XLSX.writeFile(wb, "attendance_daily.xlsx");
};

window.downloadMonthlyExcel = function(){
  const table = document.querySelector("#monthlyResult table");
  if(!table) return alert("ì¡°íšŒ í›„ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

  const wb = XLSX.utils.table_to_book(table, {sheet:"ì›”ë³„ ì¡°íšŒ"});
  XLSX.writeFile(wb, "attendance_monthly.xlsx");
};

</script>
</body>
</html>

