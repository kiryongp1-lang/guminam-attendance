<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>êµ¬ë¯¸ë‚¨ ì´ˆ2 ì¶œì„ë¶€</title>

<!-- ëª¨ë°”ì¼ ìµœì í™” -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SheetJS (ì—‘ì…€ ì €ì¥) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 15px;
    max-width: 900px;
    margin: auto;
  }
  h1 { font-size: 22px; text-align:center; }

  .box {
    border:1px solid #ccc;
    padding:15px;
    margin-bottom:20px;
    border-radius:10px;
    background:white;
  }

  button {
    padding:10px 14px;
    border:none;
    background:#007bff;
    color:white;
    border-radius:6px;
    margin-top:8px;
    cursor:pointer;
  }
  button:active { opacity:0.8; }

  input, select {
    padding:8px;
    margin:5px 0;
    width:100%;
    box-sizing:border-box;
  }

  .student-row {
    display:flex;
    justify-content:space-between;
    padding:6px 0;
    border-bottom:1px solid #eee;
    font-size:15px;
  }

  .status-radio input {
    transform:scale(1.2);
    margin-right:5px;
  }

  .missingBox {
    background:#ffeaea;
    padding:10px;
    border:1px solid red;
    border-radius:6px;
    margin-top:10px;
  }
  .clickable { color:red; cursor:pointer; font-weight:bold; }

  table {
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
    font-size:14px;
  }
  th, td {
    border:1px solid #aaa;
    padding:6px;
    text-align:center;
  }
  th { background:#f2f2f2; }
  .red { color:red; font-weight:bold; }

  .hidden { display:none; }
</style>
</head>

<body>

<h1>êµ¬ë¯¸ë‚¨ ì´ˆ2 ì¶œì„ë¶€</h1>

<!-- í•™ìƒ ë“±ë¡ -->
<button onclick="toggleRegisterUI()">í•™ìƒ ë“±ë¡</button>
<div id="registerUI" class="hidden box">
  <h2>í•™ë…„ / ë°˜ / í•™ìƒ ë“±ë¡</h2>
  <label>í•™ë…„</label>
  <input type="text" id="regGrade">

  <label>ë°˜</label>
  <input type="text" id="regClass">

  <label>í•™ìƒ ì´ë¦„</label>
  <input type="text" id="regStudent">

  <button onclick="registerStudent()">ë“±ë¡</button>
</div>

<!-- ì¶œì„ ì²´í¬ -->
<div class="box">
  <h2>ì¶œì„ ì²´í¬</h2>

  <label>ë‚ ì§œ ì„ íƒ (ì¼ìš”ì¼ë§Œ)</label>
  <input type="date" id="attDate" onchange="onSelectDate()">

  <div id="missingClassBox"></div>

  <label>í•™ë…„ ì„ íƒ</label>
  <select id="attGrade" onchange="loadClasses()"></select>

  <label>ë°˜ ì„ íƒ</label>
  <select id="attClass" onchange="loadStudents()"></select>

  <div id="studentList"></div>

  <button onclick="saveAttendance()">ì¶œì„ ì €ì¥</button>
</div>

<!-- ì¼ë³„ ì¡°íšŒ -->
<div class="box">
  <h2>ì¼ë³„ ì¡°íšŒ</h2>
  <input type="date" id="dailyQuery" onchange="queryDaily()">

  <button onclick="downloadDailyExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>

  <div id="dailyResult"></div>
</div>

<!-- ì›”ë³„ ì¡°íšŒ -->
<div class="box">
  <h2>ì›”ë³„ ì¡°íšŒ</h2>
  <input type="month" id="monthlyQuery" onchange="queryMonthly()">

  <button onclick="downloadMonthlyExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>

  <div id="monthlyResult"></div>
</div>

<script type="module">

/* ---------------------------------------
    Firebase Firestore ì„¤ì •
--------------------------------------- */
import { initializeApp } 
  from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";

import {
  getFirestore, doc, setDoc,
  collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAqOhG9cyAdrEPR_d2xRwJKDreud4mBIpk",
  authDomain: "guminam-70f61.firebaseapp.com",
  projectId: "guminam-70f61",
  storageBucket: "guminam-70f61.firebasestorage.app",
  messagingSenderId: "657304988654",
  appId: "1:657304988654:web:29f66969eb844711723cff",
  measurementId: "G-7N0PHE3P8Z"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------------------------------------
    ì „ì—­ ë°ì´í„°
--------------------------------------- */
let classes = {};
let attendance = {};

async function loadAllData() {
  classes = {};
  attendance = {};

  const cls = await getDocs(collection(db, "classes"));
  cls.forEach(d => classes[d.id] = d.data().students);

  const att = await getDocs(collection(db, "attendance"));
  att.forEach(d => attendance[d.id] = d.data());

  loadGradeDropdown();
}
await loadAllData();

/* ---------------------------------------
    UI ë„êµ¬
--------------------------------------- */
function $(id){ return document.getElementById(id); }

/* ---------------------------------------
    í•™ìƒ ë“±ë¡
--------------------------------------- */
window.toggleRegisterUI = function(){
  $("registerUI").classList.toggle("hidden");
}

window.registerStudent = async function(){
  const g = $("regGrade").value.trim();
  const c = $("regClass").value.trim();
  const s = $("regStudent").value.trim();

  if(!g || !c || !s) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");

  const key = `${g}-${c}`;

  if(!classes[key]) classes[key] = [];
  if(!classes[key].includes(s)) classes[key].push(s);

  await setDoc(doc(db, "classes", key), { students: classes[key] });

  alert("ë“±ë¡ ì™„ë£Œ!");
  loadGradeDropdown();
};

/* ---------------------------------------
    í•™ë…„ dropbox ì±„ìš°ê¸° (í•™ìƒ ìˆëŠ” ë°˜ë§Œ ëŒ€ìƒ)
--------------------------------------- */
function loadGradeDropdown(){
  const sel = $("attGrade");
  sel.innerHTML = `<option value=''>ì„ íƒ</option>`;

  // í•™ìƒì´ 1ëª… ì´ìƒ ìˆëŠ” ë°˜ë§Œ í•™ë…„ ëª©ë¡ì— ë°˜ì˜
  const grades = [...new Set(
    Object.keys(classes)
      .filter(k => Array.isArray(classes[k]) && classes[k].length > 0)
      .map(k => k.split("-")[0])
  )];

  grades.forEach(g => sel.innerHTML += `<option value="${g}">${g}</option>`);
}

/* ---------------------------------------
    í•™ë…„ ì„ íƒ â†’ ë°˜ ëª©ë¡ ë¡œë“œ (í•™ìƒ ìˆëŠ” ë°˜ë§Œ)
--------------------------------------- */
window.loadClasses = function(){
  const g = $("attGrade").value;
  const sel = $("attClass");

  sel.innerHTML = `<option value="">ì„ íƒ</option>`;

  // í•´ë‹¹ í•™ë…„ì´ë©´ì„œ, ì‹¤ì œ í•™ìƒì´ 1ëª… ì´ìƒ ìˆëŠ” ë°˜ë§Œ í‘œì‹œ
  Object.keys(classes)
    .filter(k => 
      k.split("-")[0] === g &&
      Array.isArray(classes[k]) && classes[k].length > 0
    )
    .forEach(k => {
      const c = k.split("-")[1];
      sel.innerHTML += `<option value="${c}">${c}</option>`;
    });

  loadStudents();
};

/* ---------------------------------------
    ë°˜ ì„ íƒ â†’ í•™ìƒ ëª©ë¡ í‘œì‹œ + ê¸°ì¡´ ì¶œì„ ë°˜ì˜
--------------------------------------- */
window.loadStudents = function(){
  const g = $("attGrade").value;
  const c = $("attClass").value;
  const key = `${g}-${c}`;
  const date = $("attDate").value;

  const box = $("studentList");
  if(!classes[key]){ box.innerHTML = ""; return; }

  const dayData = attendance[date]?.[key] || {};

  box.innerHTML = classes[key].map(st => {
    const prev = dayData[st] || "ë¯¸ì²´í¬";
    return `
      <div class="student-row">
        <b>${st}</b>
        <label><input type="radio" name="st_${st}" value="present"
          ${prev === "present" ? "checked" : ""}> ì¶œì„</label>

        <label><input type="radio" name="st_${st}" value="absent"
          ${prev === "absent" ? "checked" : ""}> ê²°ì„</label>

        <label><input type="radio" name="st_${st}" value="delete"> 
          âŒ ì‚­ì œ(ëª…ë‹¨)
        </label>
      </div>
    `;
  }).join('');
};


/* ---------------------------------------
    ë‚ ì§œ ì„ íƒ (ì¼ìš”ì¼ë§Œ)
--------------------------------------- */
window.onSelectDate = function(){
  const d = new Date($("attDate").value);
  if(d.getDay() !== 0){
    alert("ì¼ìš”ì¼ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    $("attDate").value = "";
    return;
  }
  showMissingClasses();
};

/* ---------------------------------------
    ë¯¸ì²´í¬ ë°˜ í‘œì‹œ (í•™ìƒ ì—†ëŠ” ë°˜ ì œì™¸)
--------------------------------------- */
function showMissingClasses(){
  const date = $("attDate").value;
  const box = $("missingClassBox");

  const data = attendance[date] || {};

  // ì‹¤ì œ í•™ìƒì´ 1ëª… ì´ìƒ ìˆëŠ” ë°˜ë§Œ ëŒ€ìƒìœ¼ë¡œ
  const activeClasses = Object.keys(classes)
    .filter(k => Array.isArray(classes[k]) && classes[k].length > 0);

  // ğŸ”¥ 'ë¯¸ì²´í¬ ë°˜' íŒë‹¨ ë¡œì§
  const missing = activeClasses.filter(key => {
    const students = classes[key];
    const dayData = data[key] || {};

    // í•™ìƒ ì¤‘ í•˜ë‚˜ë¼ë„ ì¶œì„/ê²°ì„ ì²´í¬ê°€ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ë¯¸ì²´í¬ ì²˜ë¦¬
    return students.some(st => {
      const v = dayData[st];
      return !(v === "present" || v === "absent" || v === "delete");
    });
  });

  if(missing.length === 0){
    box.innerHTML = "<b>ëª¨ë“  ë°˜ì´ ì²´í¬ë˜ì—ˆìŠµë‹ˆë‹¤.</b>";
    return;
  }

  box.innerHTML = `
    <div class='missingBox'>
      <b>ì¶œì„ ë¯¸ì²´í¬ ë°˜:</b><br>
      ${missing.map(k => 
        `<div class="clickable" onclick="selectClass('${k}')">${k}</div>`
      ).join("")}
    </div>
  `;
}

window.selectClass = function(key){
  const [g,c] = key.split("-");
  $("attGrade").value = g;
  loadClasses();
  $("attClass").value = c;
  loadStudents();
};

/* ---------------------------------------
    ì¶œì„ ì €ì¥
--------------------------------------- */
window.saveAttendance = async function(){
  const date = $("attDate").value;
  const g = $("attGrade").value;
  const c = $("attClass").value;

  if(!date || !g || !c) return alert("ë‚ ì§œ/í•™ë…„/ë°˜ì„ ì…ë ¥í•˜ì„¸ìš”.");

  const key = `${g}-${c}`;

  if(!classes[key]) return;

  if(!attendance[date]) attendance[date] = {};
  if(!attendance[date][key]) attendance[date][key] = {};

  const newStudentList = [];

  for(const st of classes[key]){

    const sel = document.querySelector(`input[name="st_${st}"]:checked`);
    const state = sel ? sel.value : "ë¯¸ì²´í¬";

    // ì‚­ì œì¸ ê²½ìš° â†’ ëª…ë‹¨ì—ì„œ ì œê±°
    if(state === "delete"){
      const ok = confirm(`${st} í•™ìƒì„ ëª…ë‹¨ì—ì„œ ì‚­ì œí• ê¹Œìš”?`);
      if(ok){
        // ì¶œì„ê¸°ë¡ì—ì„œë„ ì‚­ì œ
        delete attendance[date][key][st];
        continue; // ëª…ë‹¨ì—ë„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
      }
    }

    // ì¶œê²° ìƒíƒœ ì €ì¥
    attendance[date][key][st] = state;
    newStudentList.push(st);
  }

  // Firestore ëª…ë‹¨ ì—…ë°ì´íŠ¸
  classes[key] = newStudentList;
  await setDoc(doc(db, "classes", key), { students: newStudentList });

  // ì¶œì„ ì €ì¥
  await setDoc(doc(db, "attendance", date), attendance[date]);

  alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");

  loadStudents();        // ëª…ë‹¨ ìƒˆë¡œê³ ì¹¨
  showMissingClasses();  // ë¯¸ì²´í¬ ë°˜ ê°±ì‹ 
};


/* ---------------------------------------
    ì¼ë³„ ì¡°íšŒ
--------------------------------------- */
window.queryDaily = function(){
  const date = $("dailyQuery").value;
  const box = $("dailyResult");
  const data = attendance[date] || {};

  let html = "<table><tr><th>í•™ë…„-ë°˜/í•™ìƒ</th><th>ìƒíƒœ</th></tr>";

  Object.keys(classes).forEach(key=>{
    classes[key].forEach(st=>{
      let v = data[key]?.[st] || "ë¯¸ì²´í¬";

      if(v==="present") v="ì¶œì„";
      else if(v==="absent") v="<span class='red'>ê²°ì„</span>";
      else if(v==="delete") v="<span class='red'>ì‚­ì œ</span>";
      else v="<span class='red'>ë¯¸ì²´í¬</span>";

      html += `<tr><td>${key}/${st}</td><td>${v}</td></tr>`;
    });
  });

  box.innerHTML = html + "</table>";
};

/* ---------------------------------------
    ì›”ë³„ ì¡°íšŒ
--------------------------------------- */
window.queryMonthly = function(){
  const m = $("monthlyQuery").value;
  const year = m.split("-")[0];
  const month = Number(m.split("-")[1]);

  const days = [];

  for(let i=1;i<=31;i++){
    const d = new Date(`${m}-${String(i).padStart(2,'0')}`);
    if(d.getMonth()+1 !== month) continue;
    if(d.getDay() === 0)
      days.push(`${m}-${String(i).padStart(2,'0')}`);
  }

  let html = `<table><tr><th>í•™ë…„-ë°˜/í•™ìƒ</th>`;
  days.forEach(d => html += `<th>${d}</th>`);
  html += "</tr>";

  Object.keys(classes).forEach(key=>{
    classes[key].forEach(st=>{
      html += `<tr><td>${key}/${st}</td>`;
      days.forEach(day=>{
        let v = attendance[day]?.[key]?.[st] || "ë¯¸ì²´í¬";

        if(v==="present") v="ì¶œì„";
        else if(v==="absent") v="<span class='red'>ê²°ì„</span>";
        else if(v==="delete") v="<span class='red'>ì‚­ì œ</span>";
        else v="<span class='red'>ë¯¸ì²´í¬</span>";

        html += `<td>${v}</td>`;
      });
      html += "</tr>";
    });
  });

  $("monthlyResult").innerHTML = html + "</table>";
};

/* ---------------------------------------
    ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
--------------------------------------- */
window.downloadDailyExcel = function(){
  const table = document.querySelector("#dailyResult table");
  if(!table) return alert("ì¡°íšŒ í›„ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

  const wb = XLSX.utils.table_to_book(table, {sheet:"ì¼ë³„ ì¡°íšŒ"});
  XLSX.writeFile(wb, "attendance_daily.xlsx");
};

window.downloadMonthlyExcel = function(){
  const table = document.querySelector("#monthlyResult table");
  if(!table) return alert("ì¡°íšŒ í›„ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

  const wb = XLSX.utils.table_to_book(table, {sheet:"ì›”ë³„ ì¡°íšŒ"});
  XLSX.writeFile(wb, "attendance_monthly.xlsx");
};

</script>
</body>
</html>

